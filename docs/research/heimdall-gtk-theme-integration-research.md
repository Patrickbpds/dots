# Heimdall GTK Theme Integration Research

## Executive Summary

The Heimdall CLI generates GTK theme CSS files but they're not being properly used. Currently, the system uses the `meowrch-catppuccin-mocha` full GTK theme instead of Heimdall's generated colors. The solution is to switch to a base theme (like Adwaita or Default) and use Heimdall's CSS overrides, or properly import the generated colors.css into gtk.css.

## Current Setup Analysis

### 1. Heimdall GTK Theme Generation

#### Source: Heimdall CLI (`~/software-development/heimdall-cli/internal/theme/gtk.go`)
**Relevance**: Core implementation of GTK theme generation
**Key Points**:
- Heimdall generates complete GTK CSS with color definitions and widget styling
- Writes to paths specified in config:
  - GTK3: `~/.config/gtk-3.0/colors.css`
  - GTK4: `~/.config/gtk-4.0/colors.css`
- Generates Material Design-inspired color scheme with primary, secondary, error colors
- Includes comprehensive widget styling (buttons, entries, headers, lists, etc.)
- Uses color transformations (lighten/darken) for container variants

**Code Examples**:
```go
// Color definitions generated
@define-color background #303446;
@define-color foreground #c6d0f5;
@define-color primary #8caaee;
@define-color secondary #81c8be;
@define-color error #e78284;
```

### 2. Current File Structure

#### Source: System Configuration Files
**Relevance**: Understanding the current misconfiguration
**Key Points**:
- `~/.config/gtk-3.0/gtk.css` is a symlink to a TEMPLATE file with placeholders
- `~/.config/gtk-3.0/colors.css` contains the ACTUAL generated colors from Heimdall
- `settings.ini` specifies `gtk-theme-name=meowrch-catppuccin-mocha` which overrides CSS
- The template file has `{{.colors.background}}` placeholders instead of actual values

**Current Files**:
```
~/.config/gtk-3.0/
├── gtk.css -> ../../dots/theme/.config/gtk-3.0/gtk.css (TEMPLATE)
├── colors.css (GENERATED by Heimdall)
└── settings.ini (specifies meowrch theme)
```

### 3. Heimdall Configuration

#### Source: `~/.config/heimdall/config.json`
**Relevance**: Shows where Heimdall writes its generated themes
**Key Points**:
- GTK theme generation is enabled (`"enableGtk": true`)
- Configured paths:
  - GTK3: `/home/arthur/.config/gtk-3.0/colors.css`
  - GTK4: `/home/arthur/.config/gtk-4.0/colors.css`
- Currently using catppuccin/macchiato color scheme

### 4. Generated Colors Content

#### Source: `~/.config/gtk-3.0/colors.css`
**Relevance**: The actual theme that should be used
**Key Points**:
- Contains properly generated Catppuccin Frappé colors
- Includes terminal colors (color0-15)
- Has partial Material Design mappings (some with template placeholders)
- Includes basic widget styling

**Caveats**: 
- Some Material Design variables still have `{{placeholder}}` values
- Not being loaded because gtk.css doesn't import it

## GTK Theme Loading Mechanism

### Source: GTK Documentation
**Relevance**: Understanding how GTK loads themes
**Key Points**:
1. **Full Theme Priority**: `gtk-theme-name` in settings.ini loads a complete theme from `/usr/share/themes/`
2. **CSS Override Method**: `gtk.css` in config directory overrides theme styles
3. **Import Support**: GTK CSS supports `@import` directive to include other CSS files
4. **Loading Order**:
   - System theme (from settings.ini)
   - User gtk.css overrides
   - Application-specific CSS

**Code Examples**:
```css
/* Import colors.css into gtk.css */
@import url("colors.css");
```

## Problems Identified

1. **Wrong File Being Used**: gtk.css is a template, not the generated file
2. **Theme Override**: meowrch-catppuccin-mocha theme overrides Heimdall colors
3. **No Import Statement**: gtk.css doesn't import the generated colors.css
4. **Incomplete Generation**: Some Material Design variables aren't fully populated

## Solution Approaches

### Option 1: Use Default/Adwaita with CSS Overrides (RECOMMENDED)

**Implementation**:
```bash
# 1. Change GTK theme to Default or Adwaita
gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita'
# or
sed -i 's/gtk-theme-name=.*/gtk-theme-name=Default/' ~/.config/gtk-3.0/settings.ini

# 2. Fix gtk.css to import colors.css
echo '@import url("colors.css");' > ~/.config/gtk-3.0/gtk.css

# 3. Apply Heimdall scheme
heimdall scheme set catppuccin --flavour macchiato
```

### Option 2: Direct CSS File Usage

**Implementation**:
```bash
# 1. Remove template symlink
rm ~/.config/gtk-3.0/gtk.css

# 2. Rename colors.css to gtk.css
mv ~/.config/gtk-3.0/colors.css ~/.config/gtk-3.0/gtk.css

# 3. Update Heimdall config
# Edit ~/.config/heimdall/config.json:
# "gtk3": "/home/arthur/.config/gtk-3.0/gtk.css"
```

### Option 3: Fix Template System

**Implementation**:
```bash
# 1. Create proper import-based gtk.css
cat > ~/.config/gtk-3.0/gtk.css << 'EOF'
/* Heimdall GTK Theme Loader */
@import url("colors.css");

/* Additional overrides can go here */
EOF

# 2. Keep Heimdall writing to colors.css
# No config changes needed
```

## Verification Steps

```bash
# 1. Check current theme
gsettings get org.gnome.desktop.interface gtk-theme

# 2. Test with GTK Inspector
GTK_DEBUG=interactive nemo

# 3. Verify colors are applied
# Look for Heimdall colors in the GTK Inspector CSS tab
```

## Best Practices

1. **Use Base Theme**: Adwaita or Default as base, Heimdall CSS as overrides
2. **Separate Files**: Keep generated colors.css separate from custom gtk.css
3. **Import Method**: Use @import to include generated colors
4. **No Full Themes**: Avoid full GTK themes that override CSS customizations
5. **Test Changes**: Use GTK Inspector to verify CSS is loaded

## Recommended Configuration

### 1. Update settings.ini
```ini
[Settings]
gtk-theme-name=Adwaita
# or gtk-theme-name=Default
```

### 2. Create proper gtk.css
```css
/* Heimdall GTK Theme */
@import url("colors.css");

/* Custom overrides */
.nemo-window {
    background-color: @background;
}
```

### 3. Ensure Heimdall config is correct
```json
{
  "theme": {
    "enableGtk": true,
    "paths": {
      "gtk3": "/home/arthur/.config/gtk-3.0/colors.css",
      "gtk4": "/home/arthur/.config/gtk-4.0/colors.css"
    }
  }
}
```

## Commands to Fix

```bash
# Quick fix - Option 1 (Recommended)
gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita'
echo '@import url("colors.css");' > ~/.config/gtk-3.0/gtk.css
echo '@import url("colors.css");' > ~/.config/gtk-4.0/gtk.css
heimdall scheme set catppuccin --flavour macchiato

# Verify
nemo &  # Should show with Heimdall colors
```

## Additional Notes

- The meowrch theme might have better widget styling than pure CSS overrides
- Consider keeping some meowrch CSS rules if switching to Adwaita looks worse
- GTK4 apps need the same treatment in ~/.config/gtk-4.0/
- Some apps cache themes and need restart after changes
- The Heimdall CLI could be enhanced to generate more complete CSS or handle the import automatically